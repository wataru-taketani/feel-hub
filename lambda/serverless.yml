service: feel-hub-lambda

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-northeast-1  # 東京リージョン
  stage: ${opt:stage, 'dev'}
  memorySize: 128  # MB (APIフェッチのみ、Puppeteer不要)
  timeout: 30  # 秒（API取得+DB保存で十分）
  environment:
    SUPABASE_URL: ${env:SUPABASE_URL}
    SUPABASE_SERVICE_ROLE_KEY: ${env:SUPABASE_SERVICE_ROLE_KEY}
    ENCRYPTION_KEY: ${env:ENCRYPTION_KEY}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: 'arn:aws:logs:*:*:*'

build:
  esbuild: false

functions:
  scrapeLesson:
    handler: dist/scraper/index.handler
    description: FEELCYCLEサイトからレッスン情報をスクレイピング
    events:
      # JST 6:00-23:50 に10分間隔で実行（JST 0:00-5:59 は停止）
      # JST 6:00-23:59 = UTC 21:00-14:59
      - schedule:
          rate: cron(0/10 21-23,0-14 * * ? *)
          description: 10分間隔でレッスン情報を取得（深夜除外）
          enabled: true

  checkCancellation:
    handler: dist/scraper/checkCancellation.handler
    description: キャンセル待ちレッスンの空き枠をチェック
    events:
      # 毎分実行（Phase 3で有効化）
      - schedule:
          rate: rate(1 minute)
          description: キャンセル待ちチェック
          enabled: false  # Phase 3で有効化

plugins:
  - serverless-offline

package:
  individually: false
  patterns:
    - 'dist/**'
    - 'node_modules/**'
    - '!.git/**'
    - '!.serverless/**'
    - '!README.md'
    - '!scraper/**'
    - '!tsconfig.json'
